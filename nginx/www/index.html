<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure B2C Authentication</title>
    <script src="https://alcdn.msauth.net/browser/2.31.0/js/msal-browser.min.js"></script>
    <script>
        const msalConfig = {
            auth: {
                clientId: "d485e13b-d85e-4f76-84b5-e8f1b3a14562",
                authority: "https://testgrafana25109.b2clogin.com/testgrafana25109.onmicrosoft.com/B2C_1_SIGNIN_SIGNUP",
                knownAuthorities: ["testgrafana25109.b2clogin.com"],
                redirectUri: "http://localhost" // Update this to your app's URL if different
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let redirectInitiated = false;

        function checkAccount() {
            const currentAccounts = msalInstance.getAllAccounts();
            if (currentAccounts === null || currentAccounts.length === 0) {
                console.log('No user is logged in');
                return false;
            } else {
                console.log('User is already signed in:', currentAccounts[0]);
                return currentAccounts[0];
            }
        }

        function redirectToGrafana(account) {
            // Prepare to send a request to Grafana
            const headers = new Headers({
                'X-WEBAUTH-USER': account.username,
                // Add other headers as needed, for example:
                'X-WEBAUTH-NAME': account.name,
                'X-WEBAUTH-EMAIL': account.username // Assuming username is an email
            });

            // Perform a fetch request to Grafana
            fetch('/grafana/', {
                method: 'GET',
                headers: headers,
                credentials: 'include',  // This is important for including cookies
            })
            .then(response => {
                if (response.ok) {
                    // If the response is successful, redirect to Grafana
                    window.location.href = '/grafana/';
                } else {
                    console.error('Failed to authenticate with Grafana');
                }
            })
            .catch(error => {
                console.error('Error during Grafana authentication:', error);
            });
        }

        msalInstance.handleRedirectPromise()
            .then(response => {
                if (response) {
                    const account = response.account;
                    if (account) {
                        redirectToGrafana(account);
                    }
                } else {
                    const account = checkAccount();
                    if (account && !redirectInitiated) {
                        redirectToGrafana(account);
                    } else if (!redirectInitiated) {
                        redirectInitiated = true;
                        msalInstance.loginRedirect();
                    }
                }
            })
            .catch(error => {
                console.error('Login error:', error);
            });
    </script>
</head>
<body>
    <h1>Azure B2C Authentication with MSAL.js</h1>
</body>
</html>